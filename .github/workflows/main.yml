name: Build Netter

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_VERSION: stable

jobs:
  build-rust-cli:
    name: Build Rust CLI
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest]
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            binary_name: netter.exe
            asset_name: netter-windows.zip
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            binary_name: netter
            asset_name: netter-linux.tar.gz

    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: ${{ env.RUST_VERSION }}
        target: ${{ matrix.target }}
        override: true
    
    # Установка PostgreSQL для Windows
    - name: Install PostgreSQL (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        choco install postgresql -y
        echo "C:\Program Files\PostgreSQL\16\lib" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        echo "C:\Program Files\PostgreSQL\16\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        echo "PQ_LIB_DIR=C:\Program Files\PostgreSQL\16\lib" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        # Workaround для Rust и PostgreSQL
        mkdir -p C:\Libraries\PostgreSQL\
        xcopy "C:\Program Files\PostgreSQL\16" "C:\Libraries\PostgreSQL\" /E /I /H /Y
      
    # Установка PostgreSQL для Linux
    - name: Install PostgreSQL (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql postgresql-contrib libpq-dev
    
    - name: Cache Rust dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
    
    - name: Build CLI
      run: cargo build --release
    
    - name: Run tests
      run: cargo test --release
    
    - name: Package CLI binary (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        mkdir -p release
        cp target/release/${{ matrix.binary_name }} release/
        cd release
        7z a ../${{ matrix.asset_name }} ${{ matrix.binary_name }}
        cd ..
    
    - name: Package CLI binary (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        mkdir -p release
        cp target/release/${{ matrix.binary_name }} release/
        cd release
        tar -czf ../${{ matrix.asset_name }} ${{ matrix.binary_name }}
        cd ..
    
    - name: Upload binary as artifact
      uses: actions/upload-artifact@v4
      with:
        name: netter-cli-${{ matrix.os }}
        path: ${{ matrix.asset_name }}

  build-qt-gui:
    name: Build Qt GUI
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    # Используем официальный Qt вместо MSYS2 для упрощения
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.5.3'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2019_64'
        modules: 'qtwebsockets qtcharts qtsvg'
    
    - name: Set up Visual Studio environment
      uses: ilammy/msvc-dev-cmd@v1
    
    - name: Create build directory
      run: mkdir build
    
    - name: Configure CMake
      working-directory: build
      run: |
        cmake .. -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release
    
    - name: Build
      working-directory: build
      run: cmake --build . --config Release
    
    - name: Create deployment package
      run: |
        mkdir -p packages/NetterUI
        cp build/bin/Release/NetterUI.exe packages/NetterUI/ || cp build/bin/NetterUI.exe packages/NetterUI/
        
        # Развертывание Qt зависимостей
        windeployqt packages/NetterUI/NetterUI.exe --release
        
        # Создание bat-файла для запуска
        echo "@echo off" > packages/NetterUI/run_netter_ui.bat
        echo "chcp 65001 > nul" >> packages/NetterUI/run_netter_ui.bat
        echo "NetterUI.exe" >> packages/NetterUI/run_netter_ui.bat
        
        cd packages
        7z a -tzip ../NetterUI-windows.zip NetterUI
    
    - name: Upload Qt GUI artifact
      uses: actions/upload-artifact@v4
      with:
        name: netter-gui-windows
        path: NetterUI-windows.zip

  build-full-package:
    name: Create full package
    runs-on: windows-latest
    needs: [build-rust-cli, build-qt-gui]
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Extract all artifacts
      shell: powershell
      run: |
        mkdir -p netter-full-package
        
        # Extract CLI
        7z x artifacts/netter-cli-windows-latest/netter-windows.zip -onetter-full-package/
        
        # Extract GUI
        7z x artifacts/netter-gui-windows/NetterUI-windows.zip -onetter-full-package/
        
        cd netter-full-package
        
        # Create launcher script
        @"
        @echo off
        chcp 65001 > nul
        echo Starting Netter...
        start "" "NetterUI/NetterUI.exe"
        "@ | Out-File -FilePath "launch-netter.bat" -Encoding ASCII
        
        cd ..
        7z a netter-full-package-windows.zip netter-full-package/*
    
    - name: Upload full package
      uses: actions/upload-artifact@v4
      with:
        name: netter-full-package-windows
        path: netter-full-package-windows.zip
    
    - name: Create release (if tagged)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          netter-full-package-windows.zip
          artifacts/netter-cli-windows-latest/netter-windows.zip
          artifacts/netter-cli-ubuntu-latest/netter-linux.tar.gz
          artifacts/netter-gui-windows/NetterUI-windows.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
